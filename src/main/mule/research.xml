<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:java="http://www.mulesoft.org/schema/mule/java"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
	<sub-flow name="spacedevs-request" doc:id="82015531-5a59-4a56-b0da-7b20995eb52e" >
		<flow-ref doc:name="log-at-start" doc:id="394346d6-8884-45ec-b522-bb39db5b614a" name="log-at-start"/>
		<flow-ref doc:name="limit-offset-mode-vars" doc:id="e42c443b-17e0-4611-8f86-f27ceaa63ba4" name="limit-offset-mode-vars"/>
		<http:request method="GET" doc:name="spacedevs-request-with-query-params" doc:id="c6d0e86a-a7b9-43ce-98c7-0b09b295e71c" url="${host.spacedevs}">
			<http:query-params ><![CDATA[#[{
	limit: vars.limit,
	offset: vars.offset,
	mode: vars.mode
}]]]></http:query-params>
		</http:request>
		<choice doc:name="Choice" doc:id="72d4ed26-c800-4e64-87df-2725bfdf459c" >
			<when expression="#[vars.mode != null]">
				<logger level="INFO" doc:name="detailed-mode-not-null" doc:id="88875f7e-c6e2-4a79-ada9-24a050fa008e" message="${log.detailed-mode-in-use}"/>
			</when>
			<otherwise >
				<ee:transform doc:name="filtered-output" doc:id="27f9b46e-894d-4c9b-b04c-87dd26eaf16e" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	results: payload.results map ( result , indexOfResult ) -> {
		id: result.id,
		name: result.name,
		date_of_birth: result.date_of_birth,
		nationality: result.nationality,
		wiki: result.wiki,
		agency: {
			name: result.agency.name
		},
		last_flight: result.last_flight,
		first_flight: result.first_flight
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
		<flow-ref doc:name="log-at-exit" doc:id="4b1dcbb2-70d1-4312-92d6-de6c500e9a94" name="log-at-exit"/>
	</sub-flow>
	<sub-flow name="international-space-station-request" doc:id="86690d4d-012f-4758-9584-d20c09540279" >
		<flow-ref doc:name="log-at-start" doc:id="70f907a1-f288-4417-933f-cb46f3a83511" name="log-at-start"/>
		<http:request method="GET" doc:name="international-space-station" doc:id="2ea9ca46-720e-4ee4-872a-3fb67d53045f" url="${host.iss-astronauts}"/>
		<ee:transform doc:name="filtered-output" doc:id="48f8fbc2-1881-47b5-9fd8-c611085cdacc" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
people: payload.people map ( person , indexOfPerson ) -> {
	name: person.name,
	craft: person.craft
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="path-validation" doc:id="0f29eaf1-b548-41dc-a7cb-f4fea8f8d069" >
		<flow-ref doc:name="log-at-start" doc:id="581d8fd4-fc0b-4871-998a-d4ef498e1c60" name="log-at-start"/>
	</sub-flow>
	<sub-flow name="files-validation" doc:id="73139251-8015-40c6-9f91-9bcea7fd4622" >
		<flow-ref doc:name="log-at-start" doc:id="bbbae966-fb53-4644-b3f1-5aa89bea2e54" name="log-at-start"/>
	</sub-flow>
	<sub-flow name="files-and-path-validation-combined" doc:id="fa8a9a61-f6ae-4de7-9712-515f453ec0a1" >
		<flow-ref doc:name="path-validation" doc:id="a844655d-2977-45dd-ad88-d4940f476ddc" name="path-validation"/>
		<flow-ref doc:name="files-validation" doc:id="ac552146-256a-47b6-9a79-386e979563d3" name="files-validation"/>
	</sub-flow>
	<sub-flow name="iss-station" doc:id="8c8cae29-f82e-489d-ba13-5e8ab49f29b6" >
		<flow-ref doc:name="log-at-start" doc:id="13e346cd-7cfe-4a53-a996-6c17501fc811" name="log-at-start"/>
		<flow-ref doc:name="init-exploration-vars" doc:id="b0fc49ea-7157-47b7-a1e0-7d568dbc9f06" name="exploration-vars"/>
		<choice doc:name="Choice" doc:id="da7561e7-7fb5-4bb5-ae15-e72de3a4b3db" >
			<when expression='#[vars.station == "raw"]'>
				<flow-ref doc:name="iss-station-full-raw-information" doc:id="986a0134-a529-41c2-8b7c-337dbeae1955" name="iss-station-full-raw-information"/>
			</when>
			<when expression='#[vars.station == "link"]'>
				<flow-ref doc:name="iss-station-google-maps-link" doc:id="c3dcbe97-3484-4174-ac34-6fa127ca3084" name="iss-station-google-maps-link"/>
			</when>
			<when expression='#[vars.help == "info"]'>
				<flow-ref doc:name="help-message" doc:id="5791fc99-29a3-4c69-9974-d1d19bc39362" name="help-var"/>
			</when>
			<otherwise >
				<flow-ref doc:name="default-help-message" doc:id="ff1db1b6-4522-454d-9afd-90016f8f67ed" name="help-var"/>
			</otherwise>
		</choice>
		<flow-ref doc:name="log-at-exit" doc:id="6919b952-9104-4cb5-a7b7-54075314b958" name="log-at-exit"/>
	</sub-flow>
	<sub-flow name="iss-station-full-raw-information" doc:id="dde0640e-19dd-45e8-a392-8bf963ab1cb4" >
		<flow-ref doc:name="log-at-start" doc:id="9a3aa162-8d33-4af6-83ac-124b6e2dc3b3" name="log-at-start"/>
		<http:request method="GET" doc:name="iss-now-request" doc:id="bb809de6-348c-43d5-b887-7bd1988c419b" url="${host.iss}"/>
		<ee:transform doc:name="transform-iss-position" doc:id="ae262515-0702-463a-bc32-a84f51d50b69" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
iss_position: {
	latitude: payload.iss_position.latitude,
	longitude: payload.iss_position.longitude
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<set-variable value='#["https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyDRevuLcdraF0xTfrRxg7d063CxyXR4ew8" &#10;++ "&amp;latlng=" &#10;++ (payload.iss_position.latitude as String)&#10;++ ","&#10;++ (payload.iss_position.longitude as String)]' doc:name="location-combined-to-the-google" doc:id="dd0fb562-89bf-4c9a-b0ba-27cee39d1e4f" variableName="url"/>
		<validation:is-not-null doc:name="output-url-is-not-null" doc:id="863b4111-12e1-41d8-83c1-9f20586bb854" value="#[vars.url != null]"/>
		<http:request method="GET" doc:name="google-url-request" doc:id="30fc4faa-0622-4a3e-b9a5-1b4ea71d486e" url="#[vars.url]"/>
		<ee:transform doc:name="transform-request-output" doc:id="1212b0ee-3195-4b48-bede-7203d15010dd" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	results: payload.results map ( result , indexOfResult ) -> {
		address_components: result.address_components map ( addresscomponent , indexOfAddresscomponent ) -> {
			long_name: addresscomponent.long_name,
			short_name: addresscomponent.short_name,
			types: addresscomponent.types map ( vtype , indexOfVtype ) -> vtype
		},
		formatted_address: result.formatted_address,
		geometry: {
			location: {
				lat: result.geometry.location.lat,
				lng: result.geometry.location.lng
			},
			location_type: result.geometry.location_type
		},
		plus_code: {
			compound_code: result.plus_code.compound_code,
			global_code: result.plus_code.global_code
		}
	}
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<validation:is-empty-collection doc:name="Is empty collection" doc:id="21585153-acfe-476f-88bc-b852d52bee20" message="${validation.collectionEmpty}"/>
		<flow-ref doc:name="log-at-exit" doc:id="c3860406-4fd9-42a0-9d85-e465dce1f911" name="log-at-exit"/>
	</sub-flow>
	<sub-flow name="iss-station-google-maps-link" doc:id="9093a37a-2315-405a-835c-f214b90d0462" >
		<flow-ref doc:name="log-at-start" doc:id="39628d69-719b-434a-9244-ced49a251899" name="log-at-start"/>
		<http:request method="GET" doc:name="iss-now-request" doc:id="f3ef3e99-48a9-4bd1-88fa-1c05a4decef0" url="${host.iss}"/>
		<ee:transform doc:name="transform-output-to-the-google-maps-link" doc:id="5630cb80-65b9-4d05-ab48-6cffbe8e6999" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var googleApiLink = "https://www.google.com/maps/search/?api=1&query="
var latitude = (payload.iss_position.latitude as String)
var longitude = (payload.iss_position.longitude as String)

var completedLink = googleApiLink ++ latitude ++ "," ++ longitude
---
completedLink]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<validation:is-not-null doc:name="is-not-null-payload" doc:id="5b14e4e3-d855-4c20-af6f-e41be19bb0ee" value="#[payload]"/>
		<flow-ref doc:name="log-at-exit" doc:id="4a1ee8a8-34b9-4132-a797-85660dbb149e" name="log-at-exit"/>
	</sub-flow>
</mule>
